<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPFS QR Code Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #ffffff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-4xl mx-auto p-4">
        <!-- Login/Register View -->
        <div id="auth-view">
            <div class="flex flex-col md:flex-row bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
                <div class="w-full md:w-1/2 p-8 md:p-12">
                    <h2 class="text-3xl font-bold text-white mb-6">Login</h2>
                    <form id="loginForm" class="space-y-6">
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                        <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                        <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition duration-300">Login</button>
                    </form>
                </div>
                <div class="w-full md:w-1/2 p-8 md:p-12 bg-gray-700">
                    <h2 class="text-3xl font-bold text-white mb-6">Register</h2>
                    <form id="registerForm" class="space-y-6">
                        <input type="email" id="registerEmail" placeholder="Email" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                        <input type="password" id="registerPassword" placeholder="Password" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                        <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg transition duration-300">Register</button>
                    </form>
                </div>
            </div>
            <div id="auth-status" class="text-center p-4 mt-4 rounded-lg hidden"></div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden bg-gray-800 rounded-2xl shadow-2xl p-8 md:p-12">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-white">Your IPFS Files</h2>
                    <p id="user-email-display" class="text-gray-400"></p>
                </div>
                <div>
                    <button id="share-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2 transition duration-300">Share</button>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
                </div>
            </div>

            <!-- File Upload Form -->
            <form id="uploadForm" class="mb-8 p-6 bg-gray-700 rounded-lg">
                <h3 class="text-xl font-semibold text-white mb-4">Upload a new file</h3>
                <div class="flex items-center space-x-4">
                    <input type="file" id="fileInput" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-700" required>
                    <button type="submit" id="upload-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 flex items-center justify-center">
                        <span id="upload-btn-text">Upload</span>
                        <div id="upload-spinner" class="spinner hidden"></div>
                    </button>
                </div>
            </form>
            <div id="upload-status" class="text-center p-4 my-4 rounded-lg hidden"></div>

            <!-- File List -->
            <div id="file-list" class="space-y-4 max-h-96 overflow-y-auto no-scrollbar">
                <!-- Files will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <!-- QR Code Modal -->
    <div id="qrModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl text-center relative max-w-sm w-full">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
            <h3 class="text-2xl font-bold text-white mb-4">Share Your Public Link</h3>
            <p class="text-gray-400 mb-6">Anyone with this QR code can view your uploaded files.</p>
            <div id="qr-code-container" class="bg-white p-4 rounded-lg inline-block"></div>
             <div id="modal-spinner" class="spinner mx-auto my-10"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'https://medbloc-ipfs.onrender.com';

            // --- STATE ---
            let authToken = localStorage.getItem('authToken');
            let userEmail = localStorage.getItem('userEmail');

            // --- DOM ELEMENTS ---
            const authView = document.getElementById('auth-view');
            const dashboardView = document.getElementById('dashboard-view');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const authStatus = document.getElementById('auth-status');
            const userEmailDisplay = document.getElementById('user-email-display');
            const logoutBtn = document.getElementById('logout-btn');
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('upload-btn');
            const uploadBtnText = document.getElementById('upload-btn-text');
            const uploadSpinner = document.getElementById('upload-spinner');
            const uploadStatus = document.getElementById('upload-status');
            const fileList = document.getElementById('file-list');
            const shareBtn = document.getElementById('share-btn');
            const qrModal = document.getElementById('qrModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const qrCodeContainer = document.getElementById('qr-code-container');
            const modalSpinner = document.getElementById('modal-spinner');
            
            // --- FUNCTIONS ---
            const showDashboard = () => {
                authView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                userEmailDisplay.textContent = `Logged in as: ${userEmail}`;
            };

            const showAuthView = () => {
                dashboardView.classList.add('hidden');
                authView.classList.remove('hidden');
            };
            
            const fetchUserFiles = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/files`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch files.');
                    const files = await response.json();
                    
                    fileList.innerHTML = ''; // Clear existing list
                    if (files.length === 0) {
                         fileList.innerHTML = `<div class="text-center text-gray-500 p-4">You haven't uploaded any files yet.</div>`;
                    } else {
                        files.forEach(file => {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-center';
                            fileElement.innerHTML = `
                                <div>
                                    <p class="font-semibold text-white">${file.originalName}</p>
                                    <p class="text-xs text-gray-400">Uploaded: ${new Date(file.timestamp).toLocaleString()}</p>
                                </div>
                                <a href="https://gateway.pinata.cloud/ipfs/${file.ipfsHash}" target="_blank" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-300">
                                    View
                                </a>`;
                            fileList.appendChild(fileElement);
                        });
                    }
                } catch (error) {
                    fileList.innerHTML = `<div class="text-center text-red-400 p-4">Error: ${error.message}</div>`;
                }
            };
            
            const handleUpload = async (e) => {
                e.preventDefault();
                const file = fileInput.files[0];
                if (!file) return;

                uploadBtn.disabled = true;
                uploadBtnText.classList.add('hidden');
                uploadSpinner.classList.remove('hidden');
                uploadStatus.classList.add('hidden');

                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch(`${API_URL}/api/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        body: formData
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);

                    uploadStatus.textContent = `Success! IPFS Hash: ${data.ipfsHash}`;
                    uploadStatus.className = 'text-center p-4 my-4 rounded-lg bg-green-900 text-green-300';
                    fetchUserFiles(); // Refresh file list
                } catch (error) {
                    uploadStatus.textContent = `Error: ${error.message}`;
                    uploadStatus.className = 'text-center p-4 my-4 rounded-lg bg-red-900 text-red-300';
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtnText.classList.remove('hidden');
                    uploadSpinner.classList.add('hidden');
                    uploadStatus.classList.remove('hidden');
                    uploadForm.reset();
                }
            };

            // --- CORE LOGIC ---
            // Check if user is already logged in
            if (authToken) {
                showDashboard();
                fetchUserFiles();
            }
            
            // --- EVENT LISTENERS ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    const response = await fetch(`${API_URL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);

                    authToken = data.accessToken;
                    userEmail = data.email;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('userEmail', userEmail);
                    
                    showDashboard();
                    fetchUserFiles();

                } catch (error) {
                    authStatus.textContent = error.message;
                    authStatus.className = 'text-center p-4 mt-4 rounded-lg bg-red-900 text-red-300';
                    authStatus.classList.remove('hidden');
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;

                try {
                    const response = await fetch(`${API_URL}/api/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);

                    authStatus.textContent = data.message;
                    authStatus.className = 'text-center p-4 mt-4 rounded-lg bg-green-900 text-green-300';
                    registerForm.reset();
                } catch (error) {
                    authStatus.textContent = error.message;
                    authStatus.className = 'text-center p-4 mt-4 rounded-lg bg-red-900 text-red-300';
                } finally {
                    authStatus.classList.remove('hidden');
                }
            });
            
            logoutBtn.addEventListener('click', () => {
                authToken = null;
                userEmail = null;
                localStorage.removeItem('authToken');
                localStorage.removeItem('userEmail');
                showAuthView();
            });

            uploadForm.addEventListener('submit', handleUpload);

            shareBtn.addEventListener('click', async () => {
                qrModal.classList.remove('hidden');
                qrCodeContainer.innerHTML = '';
                modalSpinner.classList.remove('hidden');

                try {
                    const response = await fetch(`${API_URL}/api/share`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);

                    qrCodeContainer.innerHTML = `<img src="${data.qrCodeUrl}" alt="QR Code">`;
                } catch (error) {
                    qrCodeContainer.innerHTML = `<p class="text-red-400">Could not generate QR code. ${error.message}</p>`;
                } finally {
                     modalSpinner.classList.add('hidden');
                }
            });

            closeModalBtn.addEventListener('click', () => {
                qrModal.classList.add('hidden');
            });
        });
    </script>
</body>
</html>

