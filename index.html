<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPFS User Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-y: auto; /* Allow vertical scrolling */
        }
        .form-container {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .tab {
            transition: all 0.3s ease;
        }
        .tab-active {
            color: white;
            border-bottom-color: #4f46e5;
        }
        .tab-inactive {
            color: #9ca3af;
            border-bottom-color: transparent;
        }
        .input-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            pointer-events: none;
        }
        .form-input, .form-select {
            padding-left: 2.5rem !important;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%239ca3af' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4 relative">
    <!-- Background elements -->
    <div class="absolute inset-0 -z-10 h-full w-full bg-slate-950 bg-[linear-gradient(to_right,#8080800a_1px,transparent_1px),linear-gradient(to_bottom,#8080800a_1px,transparent_1px)] bg-[size:14px_24px]"></div>
    <div class="absolute left-0 top-0 -z-10 h-1/3 w-1/3 animate-pulse bg-gradient-to-tr from-indigo-900 to-purple-900 opacity-20 blur-3xl"></div>
    <div class="absolute bottom-0 right-0 -z-10 h-1/3 w-1/3 animate-pulse bg-gradient-to-bl from-blue-900 to-indigo-900 opacity-20 blur-3xl"></div>

    <!-- Main Application Container -->
    <div id="app" class="w-full max-w-4xl mx-auto my-8">

        <!-- AUTHENTICATION VIEW -->
        <div id="authView" class="w-full max-w-sm mx-auto animate-fade-in">
            <div class="form-container bg-gray-800/50 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-center mb-4 text-white">IPFS Portal</h1>
                <p class="text-center text-gray-400 mb-8">Securely upload and share your files.</p>
                
                <div class="flex border-b border-gray-600 mb-6">
                    <button id="loginTab" class="tab tab-active flex-1 py-3 font-semibold border-b-2 focus:outline-none">Login</button>
                    <button id="registerTab" class="tab tab-inactive flex-1 py-3 font-semibold border-b-2 focus:outline-none">Register</button>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="">
                    <div class="space-y-4">
                         <div class="relative">
                            <svg class="input-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.206z"></path></svg>
                            <input type="email" id="loginEmail" placeholder="Email" class="form-input w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="relative">
                             <svg class="input-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            <input type="password" id="loginPassword" placeholder="Password" class="form-input w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition-colors duration-300">Login</button>
                </form>

                <!-- Register Form (Full Version) -->
                <form id="registerForm" class="hidden">
                    <div class="space-y-4">
                        <div class="relative">
                            <svg class="input-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5zm-2.25-6.75h.008v.008h-.008v-.008z"></path></svg>
                            <input type="text" id="registerName" placeholder="Full Name" class="form-input w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="relative">
                            <svg class="input-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.206z"></path></svg>
                            <input type="email" id="registerEmail" placeholder="Email" class="form-input w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="relative">
                            <svg class="input-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            <input type="password" id="registerPassword" placeholder="Password" class="form-input w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="relative">
                            <svg class="input-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            <input type="tel" id="registerPhone" placeholder="Phone Number" class="form-input w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="relative">
                            <svg class="input-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <input type="number" id="registerAge" placeholder="Age" class="form-input w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" min="1" required>
                        </div>
                        <div class="relative">
                             <svg class="input-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6v1a6 6 0 01-6 6v-1m6-3H9m12 0h-3m-4.5-4.5a3 3 0 100-6 3 3 0 000 6z" /></svg>
                            <select id="registerGender" class="form-select w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <option value="" disabled selected>Select your gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="relative">
                            <svg class="input-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            <select id="registerRole" class="form-select w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <option value="" disabled selected>Select your role</option>
                                <option value="doctor">Doctor</option>
                                <option value="patient">Patient</option>
                            </select>
                        </div>
                        <div class="relative">
                            <svg class="input-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h8a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.737 16.5h8.526M8 11.5v3M12 11.5v3M16 11.5v3M4.5 12a7.5 7.5 0 0115 0v3a7.5 7.5 0 01-7.5 7.5S4.5 18 4.5 15v-3z"></path></svg>
                            <select id="registerState" class="form-select w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <option value="" disabled selected>Select your State/UT</option>
                                <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                                <option value="Andhra Pradesh">Andhra Pradesh</option>
                                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                <option value="Assam">Assam</option>
                                <option value="Bihar">Bihar</option>
                                <option value="Chandigarh">Chandigarh</option>
                                <option value="Chhattisgarh">Chhattisgarh</option>
                                <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                                <option value="Delhi">Delhi</option>
                                <option value="Goa">Goa</option>
                                <option value="Gujarat">Gujarat</option>
                                <option value="Haryana">Haryana</option>
                                <option value="Himachal Pradesh">Himachal Pradesh</option>
                                <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                <option value="Jharkhand">Jharkhand</option>
                                <option value="Karnataka">Karnataka</option>
                                <option value="Kerala">Kerala</option>
                                <option value="Ladakh">Ladakh</option>
                                <option value="Lakshadweep">Lakshadweep</option>
                                <option value="Madhya Pradesh">Madhya Pradesh</option>
                                <option value="Maharashtra">Maharashtra</option>
                                <option value="Manipur">Manipur</option>
                                <option value="Meghalaya">Meghalaya</option>
                                <option value="Mizoram">Mizoram</option>
                                <option value="Nagaland">Nagaland</option>
                                <option value="Odisha">Odisha</option>
                                <option value="Puducherry">Puducherry</option>
                                <option value="Punjab">Punjab</option>
                                <option value="Rajasthan">Rajasthan</option>
                                <option value="Sikkim">Sikkim</option>
                                <option value="Tamil Nadu">Tamil Nadu</option>
                                <option value="Telangana">Telangana</option>
                                <option value="Tripura">Tripura</option>
                                <option value="Uttar Pradesh">Uttar Pradesh</option>
                                <option value="Uttarakhand">Uttarakhand</option>
                                <option value="West Bengal">West Bengal</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition-colors duration-300">Create Account</button>
                </form>
                 <div id="authMessage" class="mt-4 text-center text-sm h-5"></div>
            </div>
        </div>
        
        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="hidden w-full max-w-4xl mx-auto animate-fade-in">
             <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold">Your IPFS Dashboard</h1>
                    <div class="flex items-center space-x-2 text-gray-400 mt-1">
                         <p id="userNameDisplay"></p> <!-- UPDATED ID -->
                         <span class="text-gray-600">&bull;</span>
                         <p id="userRoleDisplay" class="font-semibold capitalize"></p>
                    </div>
                </div>
                <div class="mt-4 sm:mt-0 flex space-x-2">
                    <button id="shareButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Share</button>
                    <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Logout</button>
                </div>
            </header>
            <div class="bg-gray-800/50 border border-gray-700 rounded-2xl p-6 mb-8">
                 <h2 class="text-xl font-semibold mb-4">Upload a new file</h2>
                <form id="uploadForm" class="flex flex-col sm:flex-row items-center gap-4">
                    <input type="file" id="fileInput" class="flex-grow w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer" required>
                    <button type="submit" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Upload</button>
                </form>
                <div id="uploadMessage" class="mt-4 text-center text-sm h-5"></div>
            </div>
            <div>
                <h2 class="text-xl sm:text-2xl font-bold mb-4">Your Files</h2>
                <div id="fileList" class="space-y-3"></div>
                 <div id="loadingSpinner" class="text-center py-8">
                    <svg class="animate-spin h-8 w-8 text-indigo-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>
        </div>

    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl p-6 sm:p-8 text-center relative shadow-2xl animate-fade-in w-full max-w-xs">
            <button id="closeModal" class="absolute top-2 right-4 text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            <h2 class="text-xl sm:text-2xl font-bold mb-4">Share Your Files</h2>
            <p class="text-gray-400 mb-6">Scan this QR code to view a public page of your files.</p>
            <div id="qrCodeContainer" class="bg-white p-4 rounded-lg inline-block"></div>
        </div>
    </div>
    
    <script>
        // --- CONFIGURATION ---
        const API_URL = 'https://medbloc-ipfs-1.onrender.com';

        // --- DOM ELEMENTS ---
        const authView = document.getElementById('authView');
        const dashboardView = document.getElementById('dashboardView');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const uploadForm = document.getElementById('uploadForm');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const authMessage = document.getElementById('authMessage');
        const uploadMessage = document.getElementById('uploadMessage');
        const fileList = document.getElementById('fileList');
        const userNameDisplay = document.getElementById('userNameDisplay'); // UPDATED
        const userRoleDisplay = document.getElementById('userRoleDisplay');
        const logoutButton = document.getElementById('logoutButton');
        const shareButton = document.getElementById('shareButton');
        const qrModal = document.getElementById('qrModal');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const closeModal = document.getElementById('closeModal');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // --- UTILITY FUNCTIONS ---
        const showAuthMessage = (message, isError = false) => {
            authMessage.textContent = message;
            authMessage.className = `mt-4 text-center text-sm h-5 ${isError ? 'text-red-400' : 'text-green-400'}`;
        };

        const showUploadMessage = (message, isError = false) => {
            uploadMessage.textContent = message;
            uploadMessage.className = `mt-4 text-center text-sm h-5 ${isError ? 'text-red-400' : 'text-green-400'}`;
            setTimeout(() => uploadMessage.textContent = '', 4000);
        };

        // --- CORE APPLICATION LOGIC ---
        
        const switchTab = (tab) => {
            if (tab === 'login') {
                loginTab.classList.add('tab-active');
                loginTab.classList.remove('tab-inactive');
                registerTab.classList.add('tab-inactive');
                registerTab.classList.remove('tab-active');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('tab-active');
                registerTab.classList.remove('tab-inactive');
                loginTab.classList.add('tab-inactive');
                loginTab.classList.remove('tab-active');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
            authMessage.textContent = '';
        };
        
        const showDashboard = (token, name, role) => { // UPDATED
            localStorage.setItem('accessToken', token);
            localStorage.setItem('userName', name); // UPDATED
            localStorage.setItem('userRole', role);
            authView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            userNameDisplay.textContent = name; // UPDATED
            userRoleDisplay.textContent = role || 'N/A';
            fetchUserFiles();
        };

        const logout = () => {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userName'); // UPDATED
            localStorage.removeItem('userRole');
            authView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            fileList.innerHTML = '';
        };

        const fetchUserFiles = async () => {
            loadingSpinner.classList.remove('hidden');
            fileList.innerHTML = '';
            try {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    logout();
                    return;
                }
                const response = await fetch(`${API_URL}/api/files`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401 || response.status === 403) {
                    logout();
                    return;
                }
                if (!response.ok) throw new Error('Failed to fetch files.');

                const files = await response.json();
                renderFiles(files);

            } catch (error) {
                console.error("Fetch files error:", error);
                fileList.innerHTML = `<p class="text-red-400 text-center">Could not load files. Please try again.</p>`;
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        };

        const renderFiles = (files) => {
            if (files.length === 0) {
                fileList.innerHTML = `<div class="bg-gray-800 text-center p-6 rounded-lg"><p class="text-gray-400">You haven't uploaded any files yet.</p></div>`;
                return;
            }
            files.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'bg-gray-800 p-4 rounded-lg flex items-center justify-between shadow-md animate-fade-in';
                const date = new Date(file.timestamp).toLocaleDateString();
                fileElement.innerHTML = `
                    <div>
                        <p class="font-semibold text-white">${file.originalName || 'File'}</p>
                        <p class="text-sm text-gray-400">Uploaded: ${date !== 'Invalid Date' ? date : 'N/A'}</p>
                    </div>
                    <a href="https://gateway.pinata.cloud/ipfs/${file.ipfsHash}" target="_blank" rel="noopener noreferrer" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        View
                    </a>
                `;
                fileList.appendChild(fileElement);
            });
        };

        // --- EVENT HANDLERS ---
        
        loginTab.addEventListener('click', () => switchTab('login'));
        registerTab.addEventListener('click', () => switchTab('register'));

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                showDashboard(data.accessToken, data.name, data.role); // UPDATED
            } catch (error) {
                showAuthMessage(error.message, true);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const phone = document.getElementById('registerPhone').value;
            const age = document.getElementById('registerAge').value;
            const gender = document.getElementById('registerGender').value;
            const role = document.getElementById('registerRole').value;
            const state = document.getElementById('registerState').value;
            
            try {
                const response = await fetch(`${API_URL}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password, phone, age, gender, role, state })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);
                
                showAuthMessage(data.message, false);
                switchTab('login');
                registerForm.reset();
            } catch (error) {
                showAuthMessage(error.message, true);
            }
        });
        
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                showUploadMessage('Please select a file to upload.', true);
                return;
            }
            
            showUploadMessage('Uploading, please wait...');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch(`${API_URL}/api/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message);

                showUploadMessage(`Success! IPFS Hash: ${data.ipfsHash}`, false);
                fetchUserFiles();
                uploadForm.reset();

            } catch (error) {
                showUploadMessage(error.message, true);
            }
        });

        logoutButton.addEventListener('click', logout);

        shareButton.addEventListener('click', async () => {
            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch(`${API_URL}/api/share`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Could not generate share link.');
                const data = await response.json();
                
                qrCodeContainer.innerHTML = '';
                const img = document.createElement('img');
                img.src = data.qrCodeUrl;
                qrCodeContainer.appendChild(img);
                qrModal.classList.remove('hidden');
            } catch (error)
 {
                showUploadMessage(error.message, true);
            }
        });
        
        closeModal.addEventListener('click', () => {
            qrModal.classList.add('hidden');
        });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('accessToken');
            const name = localStorage.getItem('userName'); // UPDATED
            const role = localStorage.getItem('userRole');
            if (token && name) { // UPDATED
                fetch(API_URL).then(res => {
                    if (res.ok) showDashboard(token, name, role); // UPDATED
                    else logout();
                }).catch(() => logout());
            }
        });

    </script>
</body>
</html>

