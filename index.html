<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPFS User Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Hide scrollbar for aesthetics */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-4xl mx-auto p-4">
        <!-- Login/Register View -->
        <div id="auth-view">
            <div class="flex flex-col md:flex-row bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
                <!-- Left Panel (Login) -->
                <div class="w-full md:w-1/2 p-8 md:p-12">
                    <h2 class="text-3xl font-bold text-white mb-6">Login</h2>
                    <form id="loginForm" class="space-y-6">
                        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                        <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                        <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition duration-300">Login</button>
                    </form>
                </div>
                <!-- Right Panel (Register) -->
                <div class="w-full md:w-1/2 p-8 md:p-12 bg-gray-700">
                    <h2 class="text-3xl font-bold text-white mb-6">Register</h2>
                    <form id="registerForm" class="space-y-6">
                        <input type="email" id="registerEmail" placeholder="Email" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                        <input type="password" id="registerPassword" placeholder="Password" class="w-full p-3 bg-gray-600 rounded-lg border border-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                        <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg transition duration-300">Register</button>
                    </form>
                </div>
            </div>
            <div id="auth-status" class="text-center p-4 mt-4 rounded-lg hidden"></div>
        </div>

        <!-- Uploader/Dashboard View (hidden by default) -->
        <div id="dashboard-view" class="hidden">
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 md:p-12">
                <!-- Header -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-white">IPFS Dashboard</h1>
                        <p id="userEmailDisplay" class="text-cyan-400"></p>
                    </div>
                    <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
                </div>

                <!-- Uploader -->
                <div class="bg-gray-700 p-6 rounded-lg mb-8">
                     <form id="uploadForm" class="flex items-center space-x-4">
                        <input type="file" id="file" name="file" class="w-full text-gray-400 bg-gray-600 border border-gray-500 rounded-lg cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-cyan-500 file:text-cyan-900 hover:file:bg-cyan-600" required>
                        <button type="submit" id="submitButton" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105 duration-300 ease-in-out flex items-center justify-center gap-2">
                            <span>Upload</span>
                        </button>
                    </form>
                     <div id="upload-status" class="text-center p-3 mt-4 rounded-lg hidden"></div>
                </div>

                <!-- File List -->
                <div>
                    <h2 class="text-2xl font-bold text-white mb-4">Your Uploaded Files</h2>
                    <div id="fileListContainer" class="max-h-96 overflow-y-auto space-y-3 p-1 no-scrollbar">
                        <!-- File items will be injected here by JavaScript -->
                        <p id="no-files-message" class="text-gray-400">You have not uploaded any files yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const API_URL = 'https://medbloc-ipfs.onrender.com'; // <-- For local testing. Change to your Render URL when deployed.

            // --- DOM ELEMENTS ---
            const authView = document.getElementById('auth-view');
            const dashboardView = document.getElementById('dashboard-view');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const uploadForm = document.getElementById('uploadForm');
            const authStatus = document.getElementById('auth-status');
            const uploadStatus = document.getElementById('upload-status');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const logoutButton = document.getElementById('logoutButton');
            const submitButton = document.getElementById('submitButton');
            const fileListContainer = document.getElementById('fileListContainer');
            const noFilesMessage = document.getElementById('no-files-message');

            // --- STATE MANAGEMENT ---
            let authToken = localStorage.getItem('authToken');
            let userEmail = localStorage.getItem('userEmail');

            // --- CORE LOGIC ---
            
            // Check initial auth state on page load
            const checkAuthState = () => {
                if (authToken && userEmail) {
                    showDashboard();
                    fetchUserFiles();
                } else {
                    showAuth();
                }
            };
            
            const showDashboard = () => {
                authView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                userEmailDisplay.textContent = `Logged in as: ${userEmail}`;
            };

            const showAuth = () => {
                authView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
            };

            const logout = () => {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userEmail');
                authToken = null;
                userEmail = null;
                showAuth();
            };

            const showAuthStatus = (message, isError = false) => {
                authStatus.textContent = message;
                authStatus.className = `text-center p-4 mt-4 rounded-lg ${isError ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'}`;
            };
            
             const showUploadStatus = (message, isError = false) => {
                uploadStatus.textContent = message;
                uploadStatus.className = `text-center p-3 mt-4 rounded-lg ${isError ? 'bg-red-900 text-red-300' : 'bg-green-900 text-green-300'}`;
            };
            
            const fetchUserFiles = async () => {
                if (!authToken) return;
                try {
                    const response = await fetch(`${API_URL}/api/files`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (!response.ok) throw new Error('Failed to fetch files.');
                    const files = await response.json();
                    renderFiles(files);
                } catch (error) {
                    console.error('Error fetching files:', error);
                    showUploadStatus('Could not load your files.', true);
                }
            };

            const renderFiles = (files) => {
                fileListContainer.innerHTML = ''; // Clear existing list
                if (files.length === 0) {
                     fileListContainer.appendChild(noFilesMessage);
                     noFilesMessage.classList.remove('hidden');
                } else {
                    noFilesMessage.classList.add('hidden');
                    files.forEach(file => {
                        const fileElement = document.createElement('div');
                        fileElement.className = 'bg-gray-700 p-4 rounded-lg flex justify-between items-center';
                        const gatewayUrl = `https://gateway.pinata.cloud/ipfs/${file.ipfsHash}`;
                        fileElement.innerHTML = `
                            <div>
                                <p class="font-semibold text-white">${file.fileName}</p>
                                <p class="text-xs text-gray-400">CID: ${file.ipfsHash.substring(0, 20)}...</p>
                            </div>
                            <a href="${gatewayUrl}" target="_blank" class="text-cyan-400 hover:underline">View</a>
                        `;
                        fileListContainer.appendChild(fileElement);
                    });
                }
            };

            // --- EVENT LISTENERS ---
            
            // Registration
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                try {
                    const response = await fetch(`${API_URL}/api/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    showAuthStatus(data.message);
                    registerForm.reset();
                } catch (error) {
                    showAuthStatus(error.message, true);
                }
            });

            // Login
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                try {
                    const response = await fetch(`${API_URL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Login failed.');
                    
                    authToken = data.accessToken;
                    userEmail = data.email;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('userEmail', userEmail);
                    
                    showDashboard();
                    fetchUserFiles();
                } catch (error) {
                    showAuthStatus(error.message, true);
                }
            });

            // File Upload
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('file');
                if (!fileInput.files[0]) {
                    showUploadStatus('Please select a file.', true);
                    return;
                }
                
                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="spinner"></div>`;
                showUploadStatus('Uploading your file...', false);
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                try {
                    const response = await fetch(`${API_URL}/api/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        body: formData
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Upload failed.');
                    }
                    showUploadStatus('File uploaded successfully!', false);
                    uploadForm.reset();
                    fetchUserFiles(); // Refresh the file list
                } catch (error) {
                    showUploadStatus(error.message, true);
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<span>Upload</span>`;
                }
            });

            logoutButton.addEventListener('click', logout);
            
            // --- INITIALIZATION ---
            checkAuthState();
        });
    </script>
</body>
</html>
